Битрикс монитор
===============

[![Build Status](https://travis-ci.org/webarchitect609/bitrix-monitor.svg?branch=master)](https://travis-ci.org/webarchitect609/bitrix-monitor)

Мониторинг Битрикс через HTTP-запросы.

Пакет предоставляет функционал для мониторинга различных показателей сайта под управлением Битрикс. Запрос авторизуется
по наличию токена в HTTP-заголовке X-Monitor-Token.

Примеры метрик:

* количество авторизаций за период;
* количество заказов в определённом статусе за период;
* количество добавлений товаров в корзину и в избранное(отложенное) за период;
* количество необработанных почтовых сообщений всего;

Возможно добавлять свои метрики, реализующие любую логику.

Как пользоваться:
-----------------

1 Скопируйте файл `resources/monitor-dist.php` с удобным именем в папку сайта.

2 Следуя инструкциям в файле, настройте параметры мониторинга. Не забудьте указать надёжный длинный токен! И не
подключайте Битрикс целиком! Скрипту нужен только файл dbconn.php , где объявляются глобальные переменные для доступа к
базе данных. Так скрипт будет максимально лёгким и быстрым.

3 Проверьте, что всё настроено верно. Например, через curl

```
curl -XGET 'http://example.org/bitrix-monitor.php?metric=userauth' \
    -H 'X-Monitor-Token: very-long-token-to-be-placed-here!'
```

4 Настройте ПО для мониторинга (например, Zabbix) на отправку запроса с токеном и названием запрашиваемой метрики.

И наслаждайтесь красивыми графиками мониторинга!

Известные особенности:
----------------------

1. При использовании метрики `OrderInStatusMetric` следует учитывать, что в таблице `b_sale_order` должен быть добавлен
   индекс по полю `DATE_STATUS`
   ```sql
   ALTER TABLE `b_sale_order` 
   ADD INDEX `ixs_date_status` (`DATE_STATUS` ASC)
   ```
   В противном случае запрос этой метрики будет приводить к full table scan.
